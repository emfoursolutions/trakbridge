{% extends "base.html" %}

{% block title %}Streams - GPS to TAK Server{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">GPS Streams</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('streams.create_stream') }}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus"></i> New Stream
            </a>
        </div>
    </div>
</div>

{% if streams %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>TAK Server</th>
                <th>Poll Interval</th>
                <th>Status</th>
                <th>Last Poll</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for stream in streams %}
            <tr>
                <td>
                    <a href="{{ url_for('streams.view_stream', stream_id=stream.id) }}">
                        {{ stream.name }}
                    </a>
                </td>
                <td>{{ stream.plugin_type }}</td>
                <td>{{ stream.tak_server.name if stream.tak_server else 'N/A' }}</td>
                <td>{{ stream.poll_interval }}s</td>
                <td>
                    <i class="fas fa-circle {% if stream.is_active %}status-active{% else %}status-inactive{% endif %}"></i>
                    {% if stream.is_active %}Active{% else %}Inactive{% endif %}
                </td>
                <td>
                    {% if stream.last_poll %}
                        {{ stream.last_poll.strftime('%Y-%m-%d %H:%M:%S') }}
                    {% else %}
                        Never
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        {% if stream.is_active %}
                            <button class="btn btn-outline-danger" onclick="controlStream({{ stream.id }}, 'stop')">
                                <i class="fas fa-stop"></i>
                            </button>
                        {% else %}
                            <button class="btn btn-outline-success" onclick="controlStream({{ stream.id }}, 'start')">
                                <i class="fas fa-play"></i>
                            </button>
                        {% endif %}
                        <a href="{{ url_for('streams.view_stream', stream_id=stream.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                        <button class="btn btn-outline-danger" onclick="deleteStream({{ stream.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-stream fa-3x text-muted mb-3"></i>
    <h4>No Streams Yet</h4>
    <p class="text-muted">Create your first GPS stream to get started.</p>
    <a href="{{ url_for('streams.create_stream') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Create Stream
    </a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function controlStream(streamId, action) {
    fetch(`/streams/${streamId}/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
    });
}

function deleteStream(streamId) {
    if (confirm('Are you sure you want to delete this stream?')) {
        fetch(`/streams/${streamId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}
</script>
{% endblock %}